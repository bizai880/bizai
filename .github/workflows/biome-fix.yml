name: Biome Auto-Fix

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # ÿ™ÿ¥ÿ∫ŸäŸÑ ŸäÿØŸàŸä
  schedule:
    - cron: '0 0 * * 0'  # ŸÉŸÑ ÿ£ÿ≥ÿ®Ÿàÿπ ŸäŸàŸÖ ÿßŸÑÿ£ÿ≠ÿØ

permissions:
  contents: write
  pull-requests: write

jobs:
  biome-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÿ¨ŸÑÿ® ŸÉŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ©
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci --legacy-peer-deps
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: üîß Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: 2.3.10  # ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ•ÿµÿØÿßÿ±
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîç Check Biome configuration
        run: |
          # ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ŸÖŸÑŸÅ biome.json
          biome check --diagnostic-level=error biome.json || true
          echo "‚úÖ Biome configuration is valid"

      - name: üìä Run initial check (report only)
        id: initial_check
        run: |
          echo "Running initial check..."
          biome ci . --reporter=github || true
          
          # ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
          ERRORS_COUNT=$(biome ci . --reporter=json 2>/dev/null | grep -c '"diagnostics"' || echo "0")
          echo "errors_count=$ERRORS_COUNT" >> $GITHUB_OUTPUT
          echo "Found $ERRORS_COUNT issues"

      - name: üõ†Ô∏è Apply auto-fixes
        id: apply_fixes
        run: |
          echo "Applying auto-fixes..."
          
          # 1. ÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑŸàÿßÿ±ÿØÿßÿ™ ÿ£ŸàŸÑÿßŸã
          biome check --apply --organize-imports . || true
          
          # 2. ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿµŸÑÿßÿ≠ÿßÿ™ ÿßŸÑÿ¢ŸÖŸÜÿ©
          biome check --apply . || true
          
          # 3. ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖŸÑŸÅÿßÿ™
          biome format --write . || true
          
          # 4. ÿ™ŸÜÿ≥ŸäŸÇ ŸÖŸÑŸÅÿßÿ™ JSON
          biome format --write "**/*.json" || true
          
          # ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿπÿØŸÑÿ©
          CHANGED_FILES=$(git diff --name-only 2>/dev/null | wc -l || echo "0")
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          if [ "$CHANGED_FILES" -gt "0" ]; then
            git diff --name-only | head -20
            echo "‚úÖ Fixed $CHANGED_FILES files"
          else
            echo "‚úÖ No files needed fixes"
          fi

      - name: üìã Create summary report
        if: steps.apply_fixes.outputs.changed_files != '0'
        run: |
          echo "# üìä Biome Auto-Fix Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîß Applied Fixes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Organized imports** in all files" >> $GITHUB_STEP_SUMMARY
          echo "- **Applied lint fixes** automatically" >> $GITHUB_STEP_SUMMARY
          echo "- **Formatted code** according to Biome rules" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìÅ Modified Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff --name-only 2>/dev/null | head -50 >> $GITHUB_STEP_SUMMARY || echo "No files changed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ŸàŸÑ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ•ÿµŸÑÿßÿ≠ÿßÿ™
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Fix Types Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Formatting fixes" >> $GITHUB_STEP_SUMMARY
          echo "- Import organization" >> $GITHUB_STEP_SUMMARY
          echo "- Syntax corrections" >> $GITHUB_STEP_SUMMARY
          echo "- Code style improvements" >> $GITHUB_STEP_SUMMARY

      - name: üíæ Configure Git
        if: steps.apply_fixes.outputs.changed_files != '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --local pull.rebase false

      - name: üîÑ Commit and push changes
        if: steps.apply_fixes.outputs.changed_files != '0'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: |
            ü§ñ chore(auto-fix): Apply Biome formatting and lint fixes
            
            - Organized imports automatically
            - Applied lint fixes
            - Formatted code with Biome
            - Fixed ${{ steps.apply_fixes.outputs.changed_files }} files
            
            Auto-generated by GitHub Actions
          commit_options: '--no-verify'
          branch: ${{ github.head_ref || github.ref }}
          push_options: '--force'
          create_branch: false

      - name: üìà Final check after fixes
        if: always()
        run: |
          echo "Running final check..."
          biome ci . --reporter=github-summary || true
          
          # ÿ™ŸÇÿ±Ÿäÿ± ŸÜŸáÿßÿ¶Ÿä
          FINAL_ERRORS=$(biome ci . --reporter=json 2>/dev/null | grep -c '"diagnostics"' || echo "0")
          echo "## üìä Final Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Initial issues:** ${{ steps.initial_check.outputs.errors_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fixed files:** ${{ steps.apply_fixes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "**Remaining issues:** $FINAL_ERRORS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FINAL_ERRORS" -eq "0" ]; then
            echo "‚úÖ All issues fixed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some issues require manual attention" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üö® Fail if remaining critical issues
        if: steps.initial_check.outputs.errors_count > 0 && steps.apply_fixes.outputs.changed_files == '0'
        run: |
          echo "‚ùå Critical issues found but no fixes were applied"
          echo "This usually means issues require manual intervention"
          exit 1