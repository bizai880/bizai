name: ğŸ”¥ BizAI Turborepo CI/CD

on:
  push:
    branches: [main, production]
    paths:
      - 'apps/**'
      - 'packages/**'
      - '.github/workflows/deploy.yml'
      - 'package.json'
      - 'turbo.json'
      - 'pnpm-workspace.yaml'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

# Environment variables shared across all jobs
env:
  NODE_VERSION: '20'  # Ø®ÙØ¶Øª Ù…Ù† 24 Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚Ù‹Ø§ Ù…Ø¹ biome
  TURBO_VERSION: '2.0.0'
  NPM_VERSION: '10.0.0'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: 'bizai'
  TURBO_REMOTE_CACHE: 'true'

jobs:
  # ============================================
  # 0. Ø§Ù„ÙØ­Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Biome (Ø¬Ø¯ÙŠØ¯)
  # ============================================
  code-quality-check:
    name: ğŸ” Code Quality & Auto-fix
    runs-on: ubuntu-latest
    outputs:
      code_quality_status: ${{ steps.biome-fix.outputs.status }}
      files_changed: ${{ steps.biome-fix.outputs.files_changed }}
    permissions:
      contents: write  # Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ù€ auto-commit
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest

      - name: ğŸ“ Check code quality with Biome
        id: biome-check
        run: |
          echo "=== Running Biome Code Quality Check ==="
          # ÙØ­Øµ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¥ØµÙ„Ø§Ø­Ø§Øª
          biome ci .
          echo "âœ… Code quality check passed"

      - name: ğŸ”§ Run Biome Auto-fix
        id: biome-fix
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Applying Biome Auto-fixes ==="
          
          # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
          biome check --write --unsafe .
          
          # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªØºÙŠØ±Øª
          CHANGED_COUNT=$(git diff --name-only | wc -l || echo 0)
          echo "files_changed=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "status=$([ $CHANGED_COUNT -gt 0 ] && echo 'fixed' || echo 'clean')" >> $GITHUB_OUTPUT
          
          if [ $CHANGED_COUNT -gt 0 ]; then
            echo "ğŸ”„ Fixed $CHANGED_COUNT files with Biome"
          else
            echo "âœ… Code is already clean"
          fi

      - name: ğŸ’¾ Commit and push fixes automatically
        if: steps.biome-fix.outputs.files_changed != '0'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: |
            ğŸ¤– chore(auto-fix): Biome formatting & linting
            
            Applied automatic code fixes:
            â€¢ Code formatting and style fixes
            â€¢ Lint rule violations
            â€¢ Import organization
            
            [skip ci]
          commit_user_name: 'Biome Auto-fixer ğŸ¤–'
          commit_user_email: 'bot@bizai-factory.com'
          branch: ${{ github.head_ref || github.ref }}

  # ============================================
  # 1. Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„ (Ù…Ø­Ø¯Ø«)
  # ============================================
  security-compliance:
    name: ğŸ” Security & Compliance
    runs-on: ubuntu-latest-8core
    needs: code-quality-check
    outputs:
      security_status: ${{ steps.security-output.outputs.status }}
      vulnerabilities: ${{ steps.security-output.outputs.vulnerabilities }}
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ› ï¸ Setup Turborepo environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¦ Install turbo globally
        run: npm install -g turbo@${{ env.TURBO_VERSION }}

      - name: âš™ï¸ Configure npm for security
        run: |
          npm config set registry https://registry.npmjs.org/
          npm config set audit true
          npm config set fund false
          npm config set progress false

      - name: ğŸ§¹ Install dependencies (turbo-optimized)
        run: |
          # ØªÙ†Ø¸ÙŠÙ cache Ø£ÙˆÙ„Ø§Ù‹
          rm -rf node_modules/.cache .turbo
          
          # ØªØ«Ø¨ÙŠØª dependencies Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… turbo
          npm install --legacy-peer-deps --no-audit --no-fund

      - name: ğŸ›¡ï¸ Run Biome security check
        run: |
          echo "=== Running Biome Security Rules Check ==="
          # ØªØ´ØºÙŠÙ„ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† ÙÙ‚Ø· Ù…Ù† Biome
          biome check --rules=security .

      - name: ğŸ” Run npm audit with custom thresholds
        id: npm-audit
        run: |
          echo "=== Running npm audit ==="
          
          # ÙØ­Øµ Critical vulnerabilities ÙÙ‚Ø·
          AUDIT_OUTPUT=$(npm audit --json --audit-level=critical 2>/dev/null || true)
          
          if [ -n "$AUDIT_OUTPUT" ] && [ "$AUDIT_OUTPUT" != "null" ]; then
            CRITICAL_COUNT=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.critical // 0')
            HIGH_COUNT=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.high // 0')
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::error ::ğŸš¨ Critical vulnerabilities found: $CRITICAL_COUNT"
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "vulnerabilities=$CRITICAL_COUNT critical, $HIGH_COUNT high" >> $GITHUB_OUTPUT
              exit 1
            elif [ "$HIGH_COUNT" -gt 5 ]; then  # Ø£ÙƒØ«Ø± Ù…Ù† 5 high vulnerabilities
              echo "::warning ::âš ï¸ High vulnerabilities found: $HIGH_COUNT"
              echo "status=warning" >> $GITHUB_OUTPUT
              echo "vulnerabilities=0 critical, $HIGH_COUNT high" >> $GITHUB_OUTPUT
            else
              echo "âœ… No critical vulnerabilities found"
              echo "status=passed" >> $GITHUB_OUTPUT
              echo "vulnerabilities=0 critical, $HIGH_COUNT high" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… No vulnerabilities found"
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Check package.json compliance
        run: |
          echo "=== Package Compliance Check ==="
          
          # ÙØ­Øµ ÙˆØ¬ÙˆØ¯ biome ÙÙŠ package.json
          if node -e "const pkg = require('./package.json'); console.log('âœ… Root package.json has Biome:', !!pkg.devDependencies?.['@biomejs/biome'])" 2>/dev/null; then
            echo "âœ… Biome is configured in root package.json"
          else
            echo "::warning ::âš ï¸ Biome not found in root package.json"
          fi
          
          # ÙØ­Øµ Ø¬Ù…ÙŠØ¹ package.json Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯
          for pkg in packages/*/ apps/*/; do
            if [ -f "${pkg}package.json" ]; then
              PKG_NAME=$(basename "$pkg")
              echo "ğŸ” Checking $PKG_NAME for Biome compatibility..."
            fi
          done

      - name: ğŸ“Š Security output
        id: security-output
        run: |
          echo "Security check completed with status: ${{ steps.npm-audit.outputs.status }}"
          echo "status=${{ steps.npm-audit.outputs.status }}" >> $GITHUB_OUTPUT
          echo "vulnerabilities=${{ steps.npm-audit.outputs.vulnerabilities }}" >> $GITHUB_OUTPUT

  # ============================================
  # 2. Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡ (Ù…Ø­Ø¯Ø« Ù„Ø¯Ø¹Ù… Biome)
  # ============================================
  test-build:
    name: ğŸ§ª Test & Build
    runs-on: ubuntu-latest-8core
    needs: [code-quality-check, security-compliance]
    if: |
      needs.code-quality-check.outputs.code_quality_status != 'failed' &&
      needs.security-compliance.outputs.security_status != 'failed'
    strategy:
      matrix:
        app: [web, ai-worker]
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ› ï¸ Setup Node.js with turbo cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: âš¡ Configure turbo remote cache
        run: |
          if [ -n "${{ secrets.TURBO_TOKEN }}" ]; then
            npx turbo login
            npx turbo link --no-git-check
            echo "TURBO_REMOTE_CACHE_ENABLED=true" >> $GITHUB_ENV
          else
            echo "TURBO_REMOTE_CACHE_ENABLED=false" >> $GITHUB_ENV
          fi

      - name: ğŸ“¦ Install dependencies (turbo cache optimized)
        run: |
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… turbo cache Ø¥Ù† ÙˆØ¬Ø¯
          if [ "$TURBO_REMOTE_CACHE_ENABLED" = "true" ]; then
            echo "ğŸš€ Using turbo remote cache"
            TURBO_ARGS="--remote-only"
          else
            echo "âš¡ Using local cache only"
            TURBO_ARGS=""
          fi
          
          npm install --legacy-peer-deps --no-audit --no-fund

      - name: âœ¨ Run Biome formatting check
        run: |
          echo "=== Checking code formatting with Biome ==="
          biome ci .

      - name: ğŸ”¨ Build specific app
        id: build-app
        run: |
          echo "=== Building @bizai/${{ matrix.app }} ==="
          
          if [ "${{ matrix.app }}" = "web" ]; then
            # Ø¨Ù†Ø§Ø¡ Next.js
            cd apps/web
            npm run build 2>&1 | tail -20
            BUILD_STATUS=$?
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø§Ø¬Ø­
            if [ $BUILD_STATUS -eq 0 ] && [ -d ".next" ]; then
              echo "âœ… Next.js build successful"
              echo "build_output=.next directory created" >> $GITHUB_OUTPUT
            else
              echo "::error ::Next.js build failed"
              exit 1
            fi
          else
            # Ø¨Ù†Ø§Ø¡ AI Worker
            cd apps/ai-worker
            npm run build
            BUILD_STATUS=$?
            
            if [ $BUILD_STATUS -eq 0 ] && [ -f "dist/index.js" ]; then
              echo "âœ… AI Worker build successful"
              echo "build_output=dist/index.js created" >> $GITHUB_OUTPUT
            else
              echo "::error ::AI Worker build failed"
              exit 1
            fi
          fi

      - name: ğŸ“ TypeScript type check
        run: |
          cd apps/${{ matrix.app }}
          npm run type-check

      - name: ğŸ§ª Run tests
        run: |
          cd apps/${{ matrix.app }}
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test -- --coverage
          else
            echo "âš ï¸ No tests configured for ${{ matrix.app }}"
          fi

      - name: ğŸ“Š Upload test coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          directory: ./apps/${{ matrix.app }}/coverage
          flags: ${{ matrix.app }}
          name: ${{ matrix.app }}-coverage

  # ============================================
  # 3. Ù†Ø´Ø± Ø§Ù„Ø­Ø²Ù… (npm packages) (Ù…Ø­Ø¯Ø«)
  # ============================================
  publish-packages:
    name: ğŸ“¦ Publish Packages
    runs-on: ubuntu-latest-8core
    needs: [code-quality-check, security-compliance, test-build]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.security-compliance.outputs.security_status != 'failed' &&
      needs.code-quality-check.outputs.code_quality_status != 'failed'
    outputs:
      packages_published: ${{ steps.publish-check.outputs.published }}
      published_list: ${{ steps.publish-check.outputs.package_list }}
    environment: npm-publishing
    permissions:
      contents: write
      packages: write
    steps:
      - name: â¬‡ï¸ Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ› ï¸ Setup Node.js for publishing
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@bizai'

      - name: ğŸ” Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_PUBLISH_TOKEN }}" > .npmrc
          npm config set @bizai:registry https://registry.npmjs.org
          npm config set access public
          echo "ğŸ”‘ Logged in as: $(npm whoami)"

      - name: ğŸ” Check code quality with Biome before publish
        run: |
          echo "=== Final Biome check before publishing ==="
          biome ci .

      - name: ğŸ“¦ Build all packages with turbo
        run: |
          npm install --legacy-peer-deps
          turbo build --filter=./packages/* --output-logs=summary

  # Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (deploy-vercel, deploy-worker, notify-summary) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ
  # Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© needs: [code-quality-check] ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
