# infra/docker/docker-compose.prod.yml
version: '3.8'

services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    command: >
      postgres 
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
      -c password_encryption=scram-sha-256
      -c ssl=on
      -c ssl_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
      -c ssl_key_file=/etc/ssl/private/ssl-cert-snakeoil.key

  redis:
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    command: >
      redis-server 
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000

  web:
    build:
      target: production
    environment:
      NODE_ENV: production
      PORT: 3000
    ports:
      - "3000:3000"
    command: npm run start
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        max_attempts: 3

  ai-worker:
    build:
      target: production
    environment:
      NODE_ENV: production
    deploy:
      replicas: 3
      update_config:
        parallelism: 2
        delay: 10s
      restart_policy:
        condition: on-failure
        max_attempts: 3

  nginx:
    volumes:
      - ./nginx/ssl:/etc/nginx/ssl:ro
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s

  backup:
    environment:
      SCHEDULE: "0 2 * * *"
      BACKUP_KEEP_DAYS: 30