# infra/docker/docker-compose.yml
version: '3.8'

x-common: &common
  networks:
    - bizai-network
  restart: unless-stopped

x-postgres: &postgres
  image: postgres:16-alpine
  container_name: bizai-postgres
  environment:
    POSTGRES_USER: ${DB_USER:-bizai_admin}
    POSTGRES_PASSWORD: ${DB_PASSWORD}
    POSTGRES_DB: ${DB_NAME:-bizai_production}
    POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    TZ: ${TZ:-Asia/Dubai}
    PGDATA: /var/lib/postgresql/data/pgdata
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./postgres/init:/docker-entrypoint-initdb.d:ro
    - ./postgres/conf/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    - ./postgres/conf/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
  command: >
    postgres 
    -c config_file=/etc/postgresql/postgresql.conf
    -c hba_file=/etc/postgresql/pg_hba.conf
    -c password_encryption=scram-sha-256
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-bizai_admin}"]
    interval: 10s
    timeout: 5s
    retries: 5
  <<: *common

services:
  # PostgreSQL Database
  postgres:
    <<: *postgres
    ports:
      - "${DB_PORT:-5432}:5432"

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: bizai-redis
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PORT: 6379
    command: >
      redis-server 
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    <<: *common

  # Next.js Web Application
  web:
    build:
      context: ../../apps/web
      dockerfile: ../../infra/docker/app/web/Dockerfile
      args:
        NODE_ENV: ${NODE_ENV:-production}
    container_name: bizai-web
    environment:
      # Application
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${WEB_PORT:-3000}
      NEXT_PUBLIC_APP_URL: ${APP_URL:-http://localhost:3000}
      NEXT_PUBLIC_API_URL: ${API_URL:-http://api.localhost:3001}
      
      # Database
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      DIRECT_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      
      # Security
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      SESSION_SECRET: ${SESSION_SECRET}
      
      # AI Services
      GROQ_API_KEY: ${GROQ_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # External Services
      CLOUDINARY_URL: ${CLOUDINARY_URL}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET}
      
      # Email
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
    volumes:
      - ../../apps/web:/app
      - /app/node_modules
      - /app/.next
      - ./app/shared/wait-for.sh:/wait-for.sh:ro
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        /wait-for.sh postgres:5432 &&
        /wait-for.sh redis:6379 &&
        npm run start
      "
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {if (r.statusCode !== 200) throw new Error()})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    <<: *common

  # AI Worker Service
  ai-worker:
    build:
      context: ../../apps/ai-worker
      dockerfile: ../../infra/docker/app/ai-worker/Dockerfile
    container_name: bizai-ai-worker
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      GROQ_API_KEY: ${GROQ_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      INNGEST_EVENT_KEY: ${INNGEST_EVENT_KEY}
      INNGEST_SIGNING_KEY: ${INNGEST_SIGNING_KEY}
    volumes:
      - ../../apps/ai-worker:/app
      - /app/node_modules
      - ./app/shared/wait-for.sh:/wait-for.sh:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        /wait-for.sh postgres:5432 &&
        /wait-for.sh redis:6379 &&
        npm run start:prod
      "
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:${AI_WORKER_PORT:-3001}/health', (r) => {if (r.statusCode !== 200) throw new Error()})"]
      interval: 30s
      timeout: 10s
      retries: 3
    <<: *common

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: bizai-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
      - ../../apps/web/public:/var/www/static:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - web
      - ai-worker
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    <<: *common

  # Database Backup Service
  backup:
    image: prodrigestivill/postgres-backup-local
    container_name: bizai-backup
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: 7
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      BACKUP_FILENAME: "bizai-backup-%Y%m%d-%H%M%S.sql.gz"
    volumes:
      - backup_data:/backups
      - ./postgres/scripts/backup.sh:/backup-scripts/backup.sh:ro
    depends_on:
      - postgres
    <<: *common

  # Adminer (Database Web UI)
  adminer:
    image: adminer
    container_name: bizai-adminer
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: pepa-linha
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    <<: *common

  # MailHog (Email Testing)
  mailhog:
    image: mailhog/mailhog
    container_name: bizai-mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    <<: *common

networks:
  bizai-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  backup_data:
    driver: local
  nginx_logs:
    driver: local